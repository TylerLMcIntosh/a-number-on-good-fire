Analyze data to get a number on prescribed burns in the Western US & visualize comparisons to low-severity burns
Tyler L. McIntosh
CU Boulder CIRES Earth Lab
Last updated: 11/15/23

This script uses the following naming conventions wherever possible:
 lowerCamelCase for variables
 period.separated for functions
 underscore_separated for files

# Setup

```{r, message = FALSE, warning = FALSE, include = FALSE}
## Libraries ----

#Check the required libraries and download if needed
list.of.packages <- c("tidyverse", #Includes ggplot2, dplyr, tidyr, readr, purrr, tibble, stringr, forcats
                      "terra",
                      "sf",
                      "mapview",
                      "here",
                      "future", "future.apply", "furrr", "doFuture", "progressr", #Futureverse!
                      "tictoc", 
                      "mblm", #Median-based linear models (i.e. thiel-sen)
                      "plyr",
                      "kableExtra", #nice tables
                      "googlesheets4", #read in google sheet data
                      "scales", #add commas to ggplot axis
                      "tigris", #US data
                      "scales") #add commas to axis

#Install all packages that aren't installed yet
install.packages(setdiff(list.of.packages, rownames(installed.packages())))

#Load all packages
invisible(lapply(list.of.packages, library, character.only = TRUE)) #use 'invisible' to prevent output being displayed

## Clean workspace & set up environment ----
rm(list=ls()) #Ensure empty workspace if running from beginning
here::i_am("code/04_visualize_and_compare.Rmd")
here::here() #Check here location
#OR
#setwd() #Set working directory directly
options(digits = 6) #Set standard decimal print output
options(scipen = 999) #Turn scientific notation on and off (0 = on, 999 = off)

#Ensure necessary directories are created
figsDir <- here::here("figs")
if (!dir.exists(figsDir)){
  dir.create(figsDir)
}

derivedDatDir <- here::here("data", "derived")
if (!dir.exists(derivedDatDir)){
  dir.create(derivedDatDir)
}

```

# Read in data
Read in the data;
-From Rud: https://docs.google.com/spreadsheets/d/1cGDeCfF6Gzkf9P4SRHDfqPmZfwyX438jURyzrL49IGk/edit?pli=1#gid=0
  (has three tabs of data) - all in HA
-From rx burn data munging & collating


```{r}
#From script 02
rxDatCompare <- read_csv(here::here(derivedDatDir, "rx_dataset_comparison_long_version.csv"))
nfporsWithLcms <- read_csv(here::here(derivedDatDir, "nfpors_with_lcms.csv"))

#From script 03 - all 3 sheets of data
fullDataMTBS <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1cGDeCfF6Gzkf9P4SRHDfqPmZfwyX438jURyzrL49IGk/edit?pli=1#gid=0", sheet = "Full Data")
yearSummaryMTBS <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1cGDeCfF6Gzkf9P4SRHDfqPmZfwyX438jURyzrL49IGk/edit?pli=1#gid=0", sheet = "Year Summary")
stateSummaryMTBS <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1cGDeCfF6Gzkf9P4SRHDfqPmZfwyX438jURyzrL49IGk/edit?pli=1#gid=0", sheet = "State Summary")

```

# Compare RX dats
Create comparisons of rx burn datasets (originally in script 02)

```{r}


#Plot differences by state
ggplot2::ggplot(rxDatCompare) +
  geom_line(aes(x = ACTUALCOMPLETIONYEARNEW, y = hectares, col = datNm),
            linetype = "solid") +
  facet_wrap(~STATEABBR) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Dataset comparisons by state", caption = "NFPORS_all: All area reported in NFPORS dataset \n NFPORS_FACTS: Area described by NFPORS dataset that say they are from the FACTS database \n FACTS: Area described by FACTS dataset directly \n FACTS_gis: Area described by the FACTS dataset by polygon size") +
  scale_y_continuous(labels=comma,
                     sec.axis = sec_axis(trans = ~ . * 2.47105, #add second axis showing acres
                                         name = "Acres")) +
  theme_light()
ggplot2::ggsave(here::here(figsDir, 'dataset_comparisons_state_fig.png'), units = "in", width = 10)


#Do without states
rxDatCompareNoState <- rxDatCompare %>%
  dplyr::group_by(ACTUALCOMPLETIONYEARNEW, datNm) %>%
  dplyr::summarise(hectares = sum(hectares))

#Plot differences without state breakdown
ggplot2::ggplot(rxDatCompareNoState %>% dplyr::filter(datNm == "FACTS" | datNm == "NFPORS_all")) +
  geom_line(aes(x = ACTUALCOMPLETIONYEARNEW, y = hectares, col = datNm),
            linetype = "solid") +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Dataset comparisons", caption = "NFPORS_all: All area reported in NFPORS dataset \n FACTS: Area described by FACTS dataset directly") +
  scale_y_continuous(labels=comma,
                     sec.axis = sec_axis(trans = ~ . * 2.47105, #add second axis showing acres
                                         name = "Acres")) +
  theme_light()
ggplot2::ggsave(here::here(figsDir, 'dataset_comparisons_fig.png'), units = "in", width = 10)


```

# Summarize rx with LCMS
Perform summaries of rx burn areas by state/year/landcover/WUI

```{r}

#Group by state, year, land cover
stateYearLC <- nfporsWithLcms %>%
  dplyr::group_by(STATEABBR, ACTUALCOMPLETIONYEARNEW, LandCoverDescription) %>%
  dplyr::summarise(tot = sum(TOTALACCOMPLISHMENT_HA))

ggplot(stateYearLC) +
  geom_col(aes(x = ACTUALCOMPLETIONYEARNEW, y = tot, fill = STATEABBR)) +
  facet_wrap(~LandCoverDescription) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "rx Burns by land cover type")+
  scale_y_continuous(labels=comma) +
  theme_light()
ggsave(here::here(figsDir, 'rx_by_LC_fig.png'), units = "in", width = 10)

#Filter to just forest rx
nfporsWithLcmsForest <- nfporsWithLcms %>%
  filter(LandCoverDescription == "Trees")

stateYearForest <- nfporsWithLcmsForest %>%
  dplyr::group_by(STATEABBR, ACTUALCOMPLETIONYEARNEW) %>%
  dplyr::summarise(tot = sum(TOTALACCOMPLISHMENT_HA))

ggplot(stateYearLC) +
  geom_col(aes(x = ACTUALCOMPLETIONYEARNEW, y = tot, fill = STATEABBR)) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Forest-only rx Burns by State")+
  scale_y_continuous(labels=comma) +
  theme_light()
ggsave(here::here(figsDir, 'rx_forest_by_state_fig.png'), units = "in", width = 12)

ggplot(stateYearLC) +
  geom_col(aes(x = ACTUALCOMPLETIONYEARNEW, y = tot)) +
  facet_wrap(~STATEABBR) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Forest-only rx Burns by State")+
  scale_y_continuous(labels=comma) +
  theme_light()
ggsave(here::here(figsDir, 'rx_forest_by_state_fig_facet.png'), units = "in", width = 12)


#Look at WUI rx burn #s
wuiForest <- nfporsWithLcmsForest %>%
  dplyr::group_by(iswui, ACTUALCOMPLETIONYEARNEW) %>%
  dplyr::summarise(tot = sum(TOTALACCOMPLISHMENT_HA)) %>%
  dplyr::filter(!is.na(iswui))

ggplot(wuiForest) +
  geom_col(aes(x = ACTUALCOMPLETIONYEARNEW, y = tot)) +
  facet_wrap(~iswui) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Forest-only Rx Burns by WUI")+
  scale_y_continuous(labels=comma) +
  theme_light()
ggsave(here::here(figsDir, 'rx_forest_by_wui_fig_facet.png'), units = "in", width = 12)


#All as one
rxForest <- nfporsWithLcmsForest %>%
  dplyr::group_by(ACTUALCOMPLETIONYEARNEW) %>%
  dplyr::summarise(tot = sum(TOTALACCOMPLISHMENT_HA))

ggplot(rxForest) +
  geom_col(aes(x = ACTUALCOMPLETIONYEARNEW, y = tot)) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "Forest-only Rx Burns by year")+
  scale_y_continuous(labels=comma) +
  theme_light()
ggsave(here::here(figsDir, 'rx_forest_year_fig_facet.png'), units = "in", width = 12)


```

# A few first theil-sens
Run Theil-sen on plots of interest: wui/non-wui, overall,  by state

```{r}
#Get theil-sen fits and graph
theilSenFitAll <- mblm::mblm(formula = tot ~ ACTUALCOMPLETIONYEARNEW,
                              dataframe = rxForest,
                              repeated = FALSE)

#Get estimator significance
summary.mblm(theilSenFitAll)

#Get theil-sen fits and graph
theilSenFitNonWui <- mblm::mblm(formula = tot ~ ACTUALCOMPLETIONYEARNEW,
                              dataframe = wuiForest %>% dplyr::filter(iswui == "N"),
                              repeated = FALSE)

#Get estimator significance
summary.mblm(theilSenFitNonWui)

#Get theil-sen fits and graph
theilSenFitWui <- mblm::mblm(formula = tot ~ ACTUALCOMPLETIONYEARNEW,
                            dataframe = wuiForest %>% dplyr::filter(iswui == "Y"),
                            repeated = FALSE)

#Get estimator significance
summary.mblm(theilSenFitWui)


```

# Combine rx & mtbs low-CBI from Rud

```{r}

#CBI data
stateYearCBI <- fullDataMTBS |>
  dplyr::group_by(year, State) |>
  dplyr::summarise(CBIlowmodsev = sum(CBIlowmodsev),
                   CBIhighsev = sum(CBIhighsev),
                   frcLowCbiLow = sum(frcLowCbiLow)) |>
  dplyr::mutate(frcOtherCbiLow = CBIlowmodsev - frcLowCbiLow) |>
  dplyr::select(-CBIlowmodsev)



#NFPORS data
stateYearNFPORSForest <- nfporsWithLcmsForest |>
  dplyr::group_by(STATEABBR, ACTUALCOMPLETIONYEARNEW) |>
  dplyr::summarise(rxBurnHa = sum(TOTALACCOMPLISHMENT_HA))

head(stateYearCBI)
head(stateYearNFPORSForest)

#join
stateYearCompare <- stateYearCBI |>
  full_join(stateYearNFPORSForest, join_by(State == STATEABBR, year == ACTUALCOMPLETIONYEARNEW))

stateYearCompareLong <- stateYearCompare |>
    tidyr::pivot_longer(cols = c(frcLowCbiLow,
                                 frcOtherCbiLow,
                               CBIhighsev,
                               rxBurnHa),
                                                    names_to = "datNm",
                                                    values_to = "hectares") |>
  dplyr::mutate(datNm = factor(datNm, levels = c("CBIhighsev", "frcOtherCbiLow", "frcLowCbiLow", "rxBurnHa")))

#for just states or just years
statesCompare <- stateYearCompareLong |> 
  dplyr::group_by(State, datNm) |> 
  dplyr::summarize(hectares = sum(hectares, na.rm = TRUE))
yearCompare <- stateYearCompareLong |> 
  dplyr::group_by(year, datNm) |> 
  dplyr::summarize(hectares = sum(hectares, na.rm = TRUE))

```

# Plot

```{r}
#plot
ggplot2::ggplot(statesCompare)  +
  geom_col(aes(x = State, y = hectares, fill = datNm),
            linetype = "solid") +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "MTBS CBI & RX BURN COMPARISON STATES") +
  scale_y_continuous(labels=comma,
                     sec.axis = sec_axis(trans = ~ . * 2.47105, #add second axis showing acres
                                         name = "Acres")) +
  theme_light() +
  scale_fill_manual(values = c("red", "goldenrod3", "goldenrod1", "seagreen"), labels = c("High CBI", "Low/Mod CBI in Other \n   Historical Fire Regime", "Low/Mod CBI in Low/Mod \n   Historical Fire Regime", "Prescribed Burns"))
ggplot2::ggsave(here::here(figsDir, 'cbi_rx_states_fig.png'), units = "in", width = 10)

ggplot2::ggplot(yearCompare)  +
  geom_col(aes(x = year, y = hectares, fill = datNm)) +
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "MTBS CBI & RX BURN COMPARISON YEAR") +
  scale_y_continuous(labels=comma,
                     sec.axis = sec_axis(trans = ~ . * 2.47105, #add second axis showing acres
                                         name = "Acres")) +
  theme_light() +
  scale_fill_manual(values = c("red", "goldenrod3", "goldenrod1", "seagreen"), labels = c("High CBI", "Low/Mod CBI in Other \n   Historical Fire Regime", "Low/Mod CBI in Low/Mod \n   Historical Fire Regime", "Prescribed Burns"))
ggplot2::ggsave(here::here(figsDir, 'cbi_rx_year_fig.png'), units = "in", width = 10)

ggplot2::ggplot(stateYearCompareLong)  +
  geom_col(aes(x = year, y = hectares, fill = datNm)) +
  facet_wrap(~State, scales = "free") + 
  xlab("Year") +
  ylab("Hectares") +
  labs(title = "MTBS CBI & RX BURN COMPARISON") +
  scale_y_continuous(labels=comma,
                     sec.axis = sec_axis(trans = ~ . * 2.47105, #add second axis showing acres
                                         name = "Acres")) +
  theme_light() +
  scale_fill_manual(values = c("red", "goldenrod3", "goldenrod1", "seagreen"), labels = c("High CBI", "Low/Mod CBI in Other \n   Historical Fire Regime", "Low/Mod CBI in Low/Mod \n   Historical Fire Regime", "Prescribed Burns"))
ggplot2::ggsave(here::here(figsDir, 'cbi_rx_fig.png'), units = "in", width = 10)

```
# Tabulate

```{r}
yearPerc <- stateYearCompare |>
  dplyr::select(-CBIhighsev) |>
  dplyr::group_by(year) |>
  dplyr::summarise(across(c(frcLowCbiLow, frcOtherCbiLow, rxBurnHa), sum, na.rm=TRUE)) |>
  dplyr::mutate(RxPercOfLowLow = (rxBurnHa/frcLowCbiLow) * 100) |>
  dplyr::select(year, RxPercOfLowLow)

statePerc <- stateYearCompare |>
  dplyr::select(-CBIhighsev) |>
  dplyr::group_by(State) |>
  dplyr::summarise(across(c(frcLowCbiLow, frcOtherCbiLow, rxBurnHa), sum, na.rm=TRUE)) |>
  dplyr::mutate(RxPercOfLowLow = (rxBurnHa/frcLowCbiLow) * 100) |>
  dplyr::select(State, RxPercOfLowLow)

# yrStatePerc <- stateYearCompare |>
#   dplyr::mutate(RxPercOfLowLow = (rxBurnHa/frcLowCbiLow) * 100) |>
#   dplyr::select(State, year, RxPercOfLowLow) |>
#   tidyr::pivot_wider(id_cols = State,
#                      names_from = year,
#                      values_from = RxPercOfLowLow)

yrStatePerc <- stateYearCompare |>
  dplyr::mutate(RxPercOfLowLow = (rxBurnHa/frcLowCbiLow) * 100) |>
  dplyr::select(State, year, RxPercOfLowLow)




```


# Create nice tables from tabular data

```{r}


ggplot(yrStatePerc, aes(year, State, fill = RxPercOfLowLow,
                        label = paste0(sprintf("%.1f", RxPercOfLowLow), "%"))) + 
  geom_tile() +
  geom_text(size = 3) +
  scale_fill_gradient2(low = "blue", high = "red", limits = c(0,200), midpoint = 100, na.value = "red") + 
  xlab("Year") +
  ylab("State") +
  labs(title = "Heatmap of Prescribed Burn area as \nPercentage of Low/Mod CBI in Low/Mod regime area", caption = "Red indicates that there was more prescribed burning than low-severity fire in low-regime")
ggplot2::ggsave(here::here(figsDir, 'heatmap.png'), units = "in", width = 10)



```

